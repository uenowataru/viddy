var moved = false;

$(document).ready(function(){
  loadVideos().always(function() { //is returned as deffered object
    initIFrames();
  });

  $( "#body" ).animate({
    backgroundColor: "#000000",
  },1000);

  setTimeout(function(){
    $( "#arrowL" ).animate({
      opacity: 0
    },2000);
    $( "#arrowR" ).animate({
      opacity: 0
    },2000);
    moved = false;
  }, 4000);

  var arrowtimeout;
  window.onmousemove = function(e){
    if(!moved){
      moved = true;
      $( "#arrowL" ).animate({
        opacity: 0.5
      },500);
      $( "#arrowR" ).animate({
        opacity: 0.5
      },500);
      //$( "#glass" ).style.cursor = 'default';
      arrowtimeout = setTimeout(function(){
        $( "#arrowL" ).animate({
          opacity: 0
        },1000);
        $( "#arrowR" ).animate({
          opacity: 0
        },1000);
        //$( "#glass" ).css({'cursor': 'url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAAZdEVYdFNvZnR3YXJlAFBhaW50Lk5FVCB2My41LjbQg61aAAAADUlEQVQYV2P4//8/IwAI/QL/+TZZdwAAAABJRU5ErkJggg==),url(images/blank.cur), none !important'});
        moved = false;
      }, 2000);
    }else{
      clearTimeout(arrowtimeout);
      arrowtimeout = setTimeout(function(){
        $( "#arrowL" ).animate({
          opacity: 0
        },1000);
        $( "#arrowR" ).animate({
          opacity: 0
        },1000);
        //$( "#glass" ).css({'cursor': 'url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAAZdEVYdFNvZnR3YXJlAFBhaW50Lk5FVCB2My41LjbQg61aAAAADUlEQVQYV2P4//8/IwAI/QL/+TZZdwAAAABJRU5ErkJggg==),url(images/blank.cur), none !important'});
        moved = false;
      }, 2000);
    }
  };
});
// 2. This code loads the IFrame Player API code asynchronously.
var tag = document.createElement('script');

tag.src = "https://www.youtube.com/iframe_api";
var firstScriptTag = document.getElementsByTagName('script')[0];
firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

// 3. This function creates an <iframe> (and YouTube player)
//    after the API code downloads.
var currindex = 0;
var curr;
var prev;
var next;

function initIFrames(){
  curr = new YT.Player('curr', {
    height: '390',
    width: '640',
    videoId: queue[0],
    playerVars: {
      'autoplay': 1,
      'showinfo': 0,
      'controls': 0,
      'iv_load_policy': 3,
      'disablekb': 1
    },
    events: {
      'onReady': onPlayerReady,
      'onError': onPlayerError,
      'onStateChange': onPlayerStateChange
    }
  });

  prev = new YT.Player('prev', {
    height: '390',
    width: '640',
    videoId: queue[0],
    playerVars: {
      'autoplay': 1,
      'showinfo': 0,
      'controls': 0,
      'iv_load_policy': 3,
      'disablekb': 1
    },
    events: {
      'onReady': onPlayerReady,
      'onError': onPlayerError,
      'onStateChange': onPlayerStateChange
    }
  });

  next = new YT.Player('next', {
    height: '390',
    width: '640',
    videoId: queue[1],
    playerVars: {
      'autoplay': 1,
      'showinfo': 0,
      'controls': 0,
      'iv_load_policy': 3,
      'disablekb': 1
    },
    events: {
      'onReady': onPlayerReady,
      'onError': onPlayerError,
      'onStateChange': onPlayerStateChange
    }
  });
}



function onYouTubeIframeAPIReady() {

}

// 4. The API will call this function when the video player is ready.
function onPlayerReady(event) {
  //event.target.seekTo(0);
  event.target.playVideo();
}


function onPlayerError(event) {
  if(event.target == curr){
    queue.splice(currindex,1);
    curr.loadVideoById({'videoId': queue[currindex], 'startSeconds': 0, 'suggestedQuality': 'large'});
    next.loadVideoById({'videoId': queue[currindex+1], 'startSeconds': 0, 'suggestedQuality': 'large'});
  }
  if(event.target == next){
    queue.splice(currindex+1,1);
    next.loadVideoById({'videoId': queue[currindex+1], 'startSeconds': 0, 'suggestedQuality': 'large'});
  }
}
// 5. The API calls this function when the player's state changes.
//    The function indicates that when playing a video (state=1),
//    the player should play for six seconds and then stop.
var done = false;
function onPlayerStateChange(event) {
  if (event.data == YT.PlayerState.PLAYING) {
    prev.pauseVideo();
    next.pauseVideo();
  }
  if (event.data == YT.PlayerState.ENDED)
    nextVideo();
}
function stopVideo() {
  player.stopVideo();
}

var temp;
var currdisp = "#curr";
var nextdisp = "#next";
var prevdisp = "#prev";

function nextVideo() {
  if(currindex == queue.length-1){
    currindex = 0;
    curr.loadVideoById({'videoId': queue[currindex], 'startSeconds': 0, 'suggestedQuality': 'large'});
    next.loadVideoById({'videoId': queue[currindex+1], 'startSeconds': 0, 'suggestedQuality': 'large'});
    return;
  }

  temp = prev;
  prev = curr;
  curr = next;
  next = temp;
  
  currindex++;
  if( currindex < queue.length - 1)
    next.loadVideoById({'videoId': queue[currindex+1], 'startSeconds': 0, 'suggestedQuality': 'large'});

  prev.seekTo(0);
  next.seekTo(0);
  curr.playVideo();

  temp = prevdisp;
  prevdisp = currdisp;
  currdisp = nextdisp;
  nextdisp = temp;
  $( currdisp ).css( "display", "block" );
  $( nextdisp ).css( "display", "none" );
  $( prevdisp ).css( "display", "none" );


  if(currindex > queue.length - 5)
    loadVideos();
}

function previousVideo() {
  if (currindex == 0) return;

  temp = next;
  next = curr;
  curr = prev;
  prev = temp;

  currindex--;
  if( currindex > 0)
    prev.loadVideoById({'videoId': queue[currindex-1], 'startSeconds': 0, 'suggestedQuality': 'large'});

  prev.seekTo(0);
  next.seekTo(0);
  curr.playVideo();
  temp = nextdisp;
  nextdisp = currdisp;
  currdisp = prevdisp;
  prevdisp = temp;

  $( currdisp ).css( "display", "block" );
  $( nextdisp ).css( "display", "none" );
  $( prevdisp ).css( "display", "none" );
}

$(document.activeElement).keydown(function(e) {
  switch(e.which) {
    case 37: // left
      previousVideo();
      break;

    case 39: // right
      nextVideo();
      break;

    default: return; // exit this handler for other keys
}
  e.preventDefault(); // prevent the default action (scroll / move caret)
});


function mouseMove(){

}


function mouseClick(){
  if(curr===null) return;
  if(curr.getPlayerState()==2)
    curr.playVideo();
  else
    curr.pauseVideo();
}

