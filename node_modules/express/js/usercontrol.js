var moved = false;
var arrowtimeout;
var titletimeout;
var timebartimeout;
var cursortimeout;
var timebarprog = 1;
var ClickTime = 0;
var DOUBLE_CLICK_THRESHOLD = 300;
var TOUCH_DRAG_THRESHOLD = 100;
var isTouchDevice = 'ontouchstart' in document.documentElement;

$(document).ready(function(){
  window.onmousemove = function(e){
    animateAll();
  };
});

$( document ).ready(function() {
  var isMobile = window.matchMedia("only screen and (max-width: 760px)");
  if (isMobile.matches) {
    alert('This site is not mobile friendly yet. Mobile apps are on its way!');
  }
});

if(isTouchDevice){
  window.addEventListener('load', function(){
    var glass = document.getElementById('glass');
    var startx = 0;
    var dist = 0;
 
    glass.addEventListener('touchstart', function(e){
        var touchobj = e.changedTouches[0]; // reference first touch point (ie: first finger)
        startx = parseInt(touchobj.clientX);// get x position of touch point relative to left edge of browser
        //statusdiv.innerHTML = 'Status: touchstart<br> ClientX: ' + startx + 'px';
        e.preventDefault();
    }, false);
 
    glass.addEventListener('touchmove', function(e){
        var touchobj = e.changedTouches[0]; // reference first touch point for this event
        dist = parseInt(touchobj.clientX) - startx;
        //statusdiv.innerHTML = 'Status: touchmove<br> Horizontal distance traveled: ' + dist + 'px';
        e.preventDefault();
    }, false);
 
    glass.addEventListener('touchend', function(e){
        var touchobj = e.changedTouches[0]; // reference first touch point for this even
        dist = parseInt(touchobj.clientX) - startx;
        
        if(dist > TOUCH_DRAG_THRESHOLD){
          previousVideo();
          animateTitle();
        }
        else if(dist < -TOUCH_DRAG_THRESHOLD){
          nextVideo();
          animateTitle();
        }else {
          togglePlayPause();
          animateAll();
        }
        //statusdiv.innerHTML = 'Status: touchend<br> Resting x coordinate: ' + touchobj.clientX + 'px';
        e.preventDefault();
    }, false);

  }, false);
}

$(document.activeElement).keydown(function(e) {
  if(!initialized) return;
  e.preventDefault(); // prevent the default action (scroll / move caret)
  if (e.which == 13) {
    toggleFullScreen();
  } //enter
  if(e.which== 37){
    previousVideo();
    animateTitle();
  } //left
  if(e.which == 32){
    togglePlayPause();
    animateAll();
  } //space bar
  if(e.which== 39){
    nextVideo();
    animateTitle();
  } // right
  if(e.which== 38){
    animateTimeBar();
    skipVideoTo(-2);
  } //up  //fastforward
  if(e.which== 40){
    animateTimeBar();
    skipVideoTo(-1);
  } //down   //downward
  if(e.which >= 48 && e.which <= 57){
    animateTimeBar();
    skipVideoTo(e.which - 48);
  }
});

  

function animateAll(){
  if(!moved){
    moved = true;
    loadTitle();
    animateTitle();
    animateArrow();
    animateTimeBar();
    document.body.style.cursor = 'default';
  }else{
    clearTimeout(arrowtimeout);
    clearTimeout(titletimeout);
    clearTimeout(timebartimeout);
    clearTimeout(cursortimeout);
    arrowtimeout = setTimeout(function(){
      if(isTouchDevice) return;
      $( "#arrowL" ).animate({
        opacity: 0
      },1000);
      $( "#arrowR" ).animate({
        opacity: 0
      },1000);
      moved = false;
    }, 2000);
    titletimeout = setTimeout(function(){
      $( "#title" ).animate({
        opacity: 0
      },1000);
    }, 2000);
    timebartimeout = setTimeout(function(){
      $( "#timebar" ).animate({
        opacity: 0,
        color: "#000"
      }, 1000
      );
    }, 2000);
    cursortimeout = setTimeout(function(){
      document.body.style.cursor = 'none';
    }, 2500);
  }
}


function mouseClick(){
  if(isTouchDevice) return;
  var currtime = new Date().getTime();
  if(currtime < ClickTime + DOUBLE_CLICK_THRESHOLD){
    toggleFullScreen();
  }
  ClickTime = currtime;
  togglePlayPause();
}



function arrowLeftClick(){
  if(isTouchDevice) return;
  previousVideo();
  animateTitle();
}
function arrowRightClick(){
  if(isTouchDevice) return;
  nextVideo();
  animateTitle();
}

function titleClick(){
  if(!initialized) return;
  pauseVideo();
  window.open("https://www.youtube.com/watch?v=" + queue[currindex][0]);
}

function loadTitle(){
  if(!initialized) return;
  var vidtitle = queue[currindex][1];
  $( "#title" ).text(vidtitle);
}

function animateTitle(){
  clearTimeout(titletimeout);
  $( "#title" ).animate({
    opacity: 1,
  },500);
  clearTimeout(titletimeout);
  titletimeout = setTimeout(function(){
    $( "#title" ).animate({
      opacity: 0
    },1000);
  }, 2000);

}

function animateArrow(){
  if(isTouchDevice) return;
  $( "#arrowL" ).animate({
    opacity: 0.5
  },500);
  $( "#arrowR" ).animate({
    opacity: 0.5
  },500);
  clearTimeout(arrowtimeout);
  arrowtimeout = setTimeout(function(){
    $( "#arrowL" ).animate({
      opacity: 0
    },1000);
    $( "#arrowR" ).animate({
      opacity: 0
    },1000);
  }, 2000);
}


function animateTimeBar(){
  $( "#timebar" ).animate({
    opacity: 0.75,
  },500);
  clearTimeout(timebartimeout);
  timebartimeout = setTimeout(function(){
    $( "#timebar" ).animate({
      opacity: 0,
    },1000);
  }, 2000);
}

setInterval(function(){
  try{
    $( "#timebar").width(getVideoProgress() + '%');
  }catch(err){
    //
  }
},50);


var canScroll = true;
var scrollThreshold = 250;
var wheeldelta = 0;
$('body').on ('mousewheel', function (e) {
  if(!initialized || !canScroll) return;
  wheeldelta += e.originalEvent.wheelDelta;

  if (wheeldelta < -scrollThreshold) {
    canScroll = false;
    nextVideo();
    animateTitle();
    setTimeout(function() {
      canScroll = true;
      wheeldelta = 0;
    }, 500);
  } else if (wheeldelta > scrollThreshold) {    //scrolled down
    canScroll = false;
    previousVideo();
    animateTitle();
    setTimeout(function() {
      canScroll = true;
      wheeldelta = 0;
    }, 500);
  }
});

function requestFullScreen(element) {
    // Supports most browsers and their versions.
    var requestMethod = element.requestFullScreen || element.webkitRequestFullScreen || element.mozRequestFullScreen || element.msRequestFullscreen;
    if (requestMethod) { // Native full screen.
        requestMethod.call(element);
    } else if (typeof window.ActiveXObject !== "undefined") { // Older IE.
        var wscript = new ActiveXObject("WScript.Shell");
        if (wscript !== null) {
            wscript.SendKeys("{F11}");
        }
    }
}




function toggleFullScreen() {
  if (!document.fullscreenElement &&    // alternative standard method
      !document.mozFullScreenElement && !document.webkitFullscreenElement && !document.msFullscreenElement ) {  // current working methods
    if (document.documentElement.requestFullscreen) {
      document.documentElement.requestFullscreen();
    } else if (document.documentElement.msRequestFullscreen) {
      document.documentElement.msRequestFullscreen();
    } else if (document.documentElement.mozRequestFullScreen) {
      document.documentElement.mozRequestFullScreen();
    } else if (document.documentElement.webkitRequestFullscreen) {
      document.documentElement.webkitRequestFullscreen(Element.ALLOW_KEYBOARD_INPUT);
    }
  } else {
    if (document.exitFullscreen) {
      document.exitFullscreen();
    } else if (document.msExitFullscreen) {
      document.msExitFullscreen();
    } else if (document.mozCancelFullScreen) {
      document.mozCancelFullScreen();
    } else if (document.webkitExitFullscreen) {
      document.webkitExitFullscreen();
    }
  }
}



